#!/bin/bash

# Exit on command errors and treat unset variables as an error
set -eu

# See comments in install script
app=$YNH_APP_INSTANCE_NAME
final_path=/opt/yunohost/$app

# Source YunoHost helpers
source /usr/share/yunohost/helpers

# Set permissions to app files
# you may need to make some file and/or directory writeable by www-data (nginx user)
#sudo chown -R root: $src_path

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================

ynh_app_setting_set $app final_path $final_path
# Download, check integrity, uncompress and patch the source from app.src
ynh_setup_source "$final_path"

#=================================================
# COMPOSER DEPENDENCIES
#=================================================

# Update composer dependencies
composer install --no-dev --optimize-autoloader


#=================================================
# ARTISAN ACTIONS
#=================================================

php artisan view:clear
php artisan config:clear

php artisan migrate --force
php artisan db:seed --force

chown -R www-data:www-data * 

# Reload queue runner
systemctl restart $app.service

